
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum EWalletType {
  DEPOSIT
  FEE_PAYER_FUND
  RUN_FUNDING
  VOLUME
  FEES
  MARKET_MAKING
}



model CompanyWallet {
  pubkey String @id

  encryptedPrivKey String

  type EWalletType

  isActive Boolean @default(true) // if the wallet is still actively used, especially useful for sub wallets
   
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
}

enum EServiceType {
  VOLUME
  RANKING
  MARKET_MAKING
}

model SplToken {
  tokenMint      String                        @id
  symbol         String                        
  name           String                        
  decimals       Int                           @default(9)
  isSPL          Boolean                       @default(true)
  createdAt      DateTime                      @default(now())
  updatedAt      DateTime                      @updatedAt
  lastUsdcPrice  Float?

  usedInBookedServices BookedService[]
}



model BookedService {
  id String @id @default(cuid())

  type EServiceType

  usedSplTokenMint String?
  usedSplToken SplToken? @relation(fields: [usedSplTokenMint], references: [tokenMint])

  solAmountForService Float?

  botCustomerId String 
  botCustomer BotCustomer @relation(fields: [botCustomerId], references: [id])

  mainWallet BotCustomerWallet @relation(fields: [mainWalletId], references: [pubkey])
  mainWalletId String @unique

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  description String?
}

model BotCustomerWallet {
  pubkey String @id

  encryptedPrivKey String

  type EWalletType

  botCustomerId String 
  botCustomer BotCustomer @relation(fields: [botCustomerId], references: [id])

  isActive Boolean @default(true) // if the wallet is still actively used, especially useful for sub wallets
   
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  latestSolBalance Float?
  latestTokenBalance Float?

  service BookedService?

  marketMakingJobs MarketMakingJob[]
}

model BotCustomer {
  id String @id @default(cuid())

  name String?
  email String?
  telegramUsername String?

  walletsAssociated BotCustomerWallet[]  
  bookedServices BookedService[]

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
}


enum EMarketMakingCycleType {
  PRE_PUSH
  PUSH
  POST_PUSH
  MAINTAIN
  TAKE_PROFIT
}

model MarketMakingCycle {
  id String @id @default(cuid())

  type EMarketMakingCycleType

  solSpentForCycle Float?
  maxSolSpentForCycle Float?

  solEarnedForCycle Float?
  maxSolEarnedForCycle Float?

  buyMinRange Float?
  buyMaxRange Float?

  sellToBuyValueRatio Float? // >1 => extract value, <1 => add value

  durationBetweenBuyAndSellInSeconds Int? // 30 - 300 seconds; but smaller than durationBetweenJobsInSeconds
  durationBetweenJobsInSeconds Int? // 60 - 300 seconds

  plannedTotalDurationInMinutes Int?

  startTimestamp DateTime? @default(now())
  endTimestamp DateTime?

  updatedAt             DateTime           @updatedAt

  jobs MarketMakingJob[]
}


model MarketMakingJob {
  id String @id @default(cuid())

  cycleId String
  cycle MarketMakingCycle @relation(fields: [cycleId], references: [id])

  // BUY

  buyWalletId String
  buyWallet BotCustomerWallet @relation(fields: [buyWalletId], references: [pubkey])

  earliestExecutionTimestampForBuy DateTime? // last job sets this to when the job can be executed the earliest
  latestExecutionTimestampForBuy DateTime? // last job sets this to when the job can be executed the latest
  executedAtForBuy DateTime?

  tokenPriceAtBuy Float?
  solSpent Float?
  tokenBought Float?

  // SELL

  earliestExecutionTimestampForSell DateTime? // after the buy, this job sets this to when it should sell the earliest
  latestExecutionTimestampForSell DateTime? // after the buy, this job sets this to when it should sell the latest
  executedAtForSell DateTime?

  tokenPriceAtSell Float?
  solEarned Float?
  tokenSold Float?

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
}